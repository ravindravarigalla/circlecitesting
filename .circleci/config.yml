version: 2.1
orbs:
  node: circleci/node@1.0.1
  gcp-gke: circleci/gcp-gke@0.1.0
  gcr: circleci/gcp-gcr@0.0.2
jobs:
  build:
    description: Install npm
    # machine option runs your jobs in a dedicated, ephemeral VM that has the following specifications:
    machine: true
    steps:
      - checkout
      # Install node
      - node/install
      # Install npm
      - node/install-npm
      # Download and cache dependencies
      - node/with-cache:
          steps:
            - run:
                name: {
  "type": "service_account",
  "project_id": "sincere-chariot-264308",
  "private_key_id": "57f3c0e41a4583ebac211127ca2d25bc5d9bb3d4",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDVRXpPJ/dCLMBc\n1jG1VkQv+WBfEoVDzitetCfK0mOG+vRZ5YlHhnDA8PULACKKzfVnnRC8N9ky0Zvg\ncOfziagmSZ83n6fN6Fw1wIYAWj9Vv8tn1Tkg5vC69Q2tFgUG6dMB57Ye6M+cgK1d\nLFQlxlPgcLxu0ezFVkNuLcQJ4NjNZj/OjjESpJcomujEsxC3BOsWfu+dUeEXasux\nOcx79pAKU1Vs1WBWDFIoiRQf5AZ3hWiTaLKR9eihzbrhWFKqI+QNI9Bp/aeWlV1r\nY8QpdV9/7OvPVCmMje5WVpj8edPjM5LaTh5uh6Cj5nDeXmS0AAmuFmSr7IUcsK3C\npD+aAyRlAgMBAAECggEADPg8L2slSMNy8VJfVIFKBUbbmvyD2TNFBO3cy6NOxSsm\nx/7DAfQFkF428LPR5fIPff0ZwvB8h3Ai1BvZp0BUVvu8MIRHjqiWTviFzaivWFYh\nFw/q+PrCYgQ8EC4aISkAGYoPU8LhuUlEAboL5f4xJKGGfBDNHtUXpbAnz1f6p0b3\np+HbJBfcUemGETdNEt/e8ynNA7KIRaf67HhHSN3Cfhec3VbxWcRbl/R1Yvn/2T0m\n27Hu9c5Xc0c2G/GBIT2WYpem2Jzw6eP8uFXirHKjwXznKNTme/uGp+j47MMZY12M\nPNK5Bx716XfGXm4EyfRJ8JldrM1u6QFHnTOqIU9dgQKBgQDqw3Mzskpy0gwk6Pdc\neAUxf3Au6Ju1WODaRWA3WiEfLRbjkQWOtUy/dn0KMmXrguiGoAGIr85FbeRe6c4H\nJkS0L7Z/M0Xmn3AVDjuNzX350Aa+LBWfEJzU/Gwb1rw3sbba5klsjSvJ993uWD2u\nX11BRuEhrIQ1aS0t5AMqFQMwQQKBgQDokFLWtiKN0rKbusITnt64drt+3grdJK9a\ngmovuzgMH9705Y4xWn8PYiuOH4FUAtcitRQRhhb8F+VJppFCcUtpRw45dnNP3Lhe\naDr/9vjkw3reKqSu2PNGKGJbooslRLqh5cLdogahrzueGUrd9slkwMsRNNec+jCR\nNrTpIuJrJQKBgFIJ1xo7tdSGHoRPfRGtR3NSq2tZEgC/fGQKVmNBdc2lPhhsN1r1\ndEp8J5oGnqM8bfGNvLt9ZEHS8zlPzxWkg+HLwqSU0FqVYN+ax6j4JIvF7HVMhom9\njnDHfSgFVGTKD7JTQ1lRw/miSsXdxEBJRxdmo4nW9aSMiqM8yPZNvX2BAoGBANXf\nlC8dRN3EfLk2oTDGE/D0UC22KauCBzlnYhwPQtXzoWj6iy/cF6mgEIodcyQ9kHe8\nq34KIK0plJWM911xL3bb/7rcseMqCuvXUxr+l5paI26ZLOYXYnKMxRecffaCJFir\nIfANB6g9rMgSXoWOZVug6Z8jR353n56L/wfAKxV5AoGAflQoek9QCmE+5YEgknzD\nj8wSTGupePPYSzWUHZ+Uy2anSb02//Q5dby6ikoi9ZZFdRx09ywKrYMvUQYHTZS1\n8T6PaWXXJoyQNXwFs+WlU42hg6M/GwOBcCjbBtsftmFaCGTFlSdMat4P3zMAODZJ\nzEiwODrJ51zKDT5Gqz5mE08=\n-----END PRIVATE KEY-----\n",
  "client_email": "ravindra@sincere-chariot-264308.iam.gserviceaccount.com",
  "client_id": "100617920517514130291",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/ravindra%40sincere-chariot-264308.iam.gserviceaccount.com"
}
                command: install-npm
          # Save cache
          cache-key: package.json
          # Ignore non-checksum cache hits
          use-strict-cache: true
  Build-Push-Image-Docker:
    description: Build and push image to Google Container Registry
    machine: true
    steps:
      - checkout
      - gcr/gcr-auth
      - gcr/build-image:
          image: testing
          tag: "latest" #Change version number e.g to 'v3' when updating application
      - gcr/push-image:
          image: testing
          tag: "latest" #Change version number e.g to 'v3' when updating application
    
  deploy:
    description: Deploy application to Google Kubernetes Engine
    machine: true
    steps:
      # Install `gcloud` and `kubectl` if not already installed.
      - gcp-gke/install
      # Initialize the `gcloud` CLI.
      - gcp-gke/init
      # Update a deployment Docker image.
      - gcp-gke/rollout-image:
          deployment: circle-ci-cluster
          container: dominic-backend
          image: gcr.io/sequeslife/testing:latest # change version when updating
workflows:
  build_update_deploy:
    jobs:
      - build
      - Build-Push-Image-Docker:
          requires:
            - build
      - deploy:
          requires:
            - Build-Push-Image-Docker
      
